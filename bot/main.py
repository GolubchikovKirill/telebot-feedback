import os
from abc import ABC, abstractmethod
from collections import defaultdict
from telebot import TeleBot
from dotenv import load_dotenv
from telebot.types import (
    ReplyKeyboardMarkup,
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton
)

from db.database import db
from db.models import Feedback, Students

load_dotenv()
TOKEN = os.getenv("TOKEN")


class BotHandler(ABC):
    @abstractmethod
    def handle(self, message: Message | CallbackQuery):
        pass


class StartHandler(BotHandler):
    def __init__(self, bot: TeleBot):
        self.bot = bot

    def handle(self, message: Message):
        image_url = "https://disk.yandex.ru/i/7MNk0dTd9YzMUQ"
        self.bot.send_photo(
            message.chat.id,
            image_url,
            caption="<b>–£–≤–∞–∂–∞–µ–º—ã–π —Å—Ç—É–¥–µ–Ω—Ç! –Ø <s>–±–æ—Ç</s> –∫–æ—Ç –¥–ª—è —Å–±–æ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.</b>\n"
                    "<b>–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ç–µ–º, —á—Ç–æ —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –∏/–∏–ª–∏ —Ç—ã —Ö–æ—Ç–µ–ª –±—ã –¥–æ–±–∞–≤–∏—Ç—å, "
                    "–Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.</b>",
            parse_mode="HTML",
            reply_markup=FeedbackBot.markup_main()
        )


class FeedbackHandler(BotHandler):
    def __init__(self, bot: TeleBot):
        self.bot = bot

    def handle(self, message: Message):
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("–ß—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å", callback_data="liked"))
        keyboard.add(InlineKeyboardButton("–ß—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å", callback_data="add"))
        self.bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏:", reply_markup=keyboard)


class HelpHandler(BotHandler):
    def __init__(self, bot: TeleBot):
        self.bot = bot

    def handle(self, message: Message):
        self.bot.send_message(
            message.chat.id,
            "<b>–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å, –Ω—É–∂–Ω–æ:</b>\n"
            "1. –ù–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å'.\n"
            "2. –í—ã–±—Ä–∞—Ç—å —Ç–∏–ø –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.\n"
            "3. –ù–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n"
            "4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ.\n"
            "\n"
            "<b>–ö–Ω–æ–ø–∫–∞ '–¶–∏—Ñ—Ä–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã' —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏.</b>\n"
            "\n"
            "<b>–ß—Ç–æ–±—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—É - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ò–≥—Ä–∞—Ç—å'.</b>\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫, –∑–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ, –ª–∏–±–æ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å\n"
            "–ö–Ω–æ–ø–∫–∞ '–î–∞–ª–µ–µ', —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –ø–æ–∫–∞ –Ω–µ –¥–æ–π–¥–µ—Ç–µ –¥–æ –∫–æ–Ω—Ü–∞.",
            parse_mode="HTML"
        )


class ResourcesHandler(BotHandler):
    def __init__(self, bot: TeleBot):
        self.bot = bot

    def handle(self, message: Message):
        image_url = "https://disk.yandex.ru/i/gqOpER4MIq1pwA"
        caption = """
        <b>üìö –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞ –†–ì–ü–£ –∏–º. –ê. –ò. –ì–µ—Ä—Ü–µ–Ω–∞</b>
–ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.
        üëâ <a href="https://inpsy.hspu.org/">–°–∞–π—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π 
            —Å–ª—É–∂–±—ã</a>

<b>üñºÔ∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç—É—Ä –ø–æ 
        –†—É—Å—Å–∫–æ–º—É –º—É–∑–µ—é</b>
        üëâ <a href="https://virtual.rusmuseumvrm.ru">–ü–æ—Å–µ—Ç–∏—Ç—å –º—É–∑–µ–π</a>

<b>üí™ –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π —Ñ–∏—Ç–Ω–µ—Å 
        –∫–ª—É–± "PROFIT"</b>
        üëâ <a href="https://vk.com/studprofit">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ –∫–ª—É–±</a>

<b>üéÆ –ì–µ—Ä—Ü–µ–Ω–æ–≤—Å–∫–∏–π –∏–≥—Ä–æ–≤–æ–π 
        –∫–ª—É–±</b>
        üëâ <a href="https://vk.com/herzengame">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</a>

<b>üåç –ê—Ç–ª–∞—Å —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏—Ö 
        –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π</b>
        üëâ <a href="https://www.herzen.spb.ru/about/struct-uni/contr/dep-edu-pract-youth-projects/atlas-studencheskikh-obedineniy/">–°–º–æ—Ç—Ä–µ—Ç—å –∞—Ç–ª–∞—Å</a>
        """
        self.bot.send_photo(message.chat.id, image_url, caption=caption, parse_mode="HTML")


class FeedbackCallbackHandler(BotHandler):
    def __init__(self, bot: TeleBot):
        self.bot = bot
        self.states = defaultdict(dict)

    def handle(self, call: CallbackQuery):
        chat_id = call.message.chat.id
        data = call.data

        if data in ("liked", "add"):
            self.bot.answer_callback_query(call.id)
            self.states[chat_id] = {"state": "waiting_feedback", "type": data}
            self.bot.send_message(
                chat_id,
                "–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à—É –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å:",
                reply_markup=InlineKeyboardMarkup().add(
                    InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel_feedback")
                )
            )

        elif data == "cancel_feedback":
            self.bot.answer_callback_query(call.id)
            if chat_id in self.states:
                del self.states[chat_id]
            self.bot.send_message(
                chat_id,
                "–û—Ç–º–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è",
                reply_markup=FeedbackBot.markup_main()
            )

        elif data == "feedback_end":
            self.bot.answer_callback_query(call.id, "–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!")
            if chat_id in self.states:
                del self.states[chat_id]
            self.bot.send_message(chat_id, "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É.")


class BotGame:
    def __init__(self, bot: TeleBot):
        self.bot = bot
        self.selected_parts = defaultdict(lambda: defaultdict(int))
        self.button_names = {
            1: ["1.1 –ü—Ä–µ–æ–¥–æ–ª–µ–≤–∞—è –ø—Ä–µ–≥—Ä–∞–¥—ã", "1.2 –î–µ–π—Å—Ç–≤–∏–µ - –º–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "1.3 –°–∏–ª–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —à–∞–≥–æ–≤"],
            2: ["2.1 –†–µ—Å—É—Ä—Å—ã –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—è", "2.2 –ò—Å–ø–æ–ª—å–∑—É—è –∫–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç", "2.3 –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—â–µ–Ω–∏—è"],
            3: ["3.1 –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ", "3.2 –ü—Ä–∏–Ω—è—Ç–∏–µ –≤ –≥—Ä—É–ø–ø–µ", "3.3 –ó–Ω–∞—á–∏–º—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è"],
            4: ["4.1 –û–±—â–µ–Ω–∏–µ —Å –≥—Ä—É–ø–ø–æ–π", "4.2 –°–æ—Ü–∏–∞–ª—å–Ω–∞—è –±–∞—Ç–∞—Ä–µ–π–∫–∞", "4.3 –¢—ë–ø–ª—ã–π –∫—Ä—É–≥ –æ–±—â–µ–Ω–∏—è"],
            5: ["5.1 –õ–∏—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã", "5.2 –ö–∞–∫ —Å–∫–∞–∑–∞—Ç—å –ù–ï–¢", "5.3 –ß—É–∂–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è"],
            6: ["6.1 –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥ - –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "6.2 –í–æ–ø—Ä–æ—Å—ã –±—ã—Ç–∞", "6.3 –ó–æ–≤ —Ä–æ–¥–Ω–æ–≥–æ –∫—Ä–∞—è"],
            7: ["7.1 –ö—É–ª—å—Ç—É—Ä–Ω—ã–π —à–æ–∫", "7.2 –í –ø–æ–∏—Å–∫–µ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π", "7.3 –°–≤—è–∑—å —Å –∫—É–ª—å—Ç—É—Ä–æ–π"],
            8: ["8.1 –≠–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å", "8.2 –ù–æ–≤—ã–µ –≤—ã–∑–æ–≤—ã —É—á—ë–±—ã", "8.3 –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"],
            9: ["9.1 –ù–æ–≤—ã–µ —Å–º—ã—Å–ª—ã", "9.2 –í –ø–æ–∏—Å–∫–∞—Ö –±–∞–ª–∞–Ω—Å–∞", "9.3 –ü—Ä–∏–Ω—è—Ç–∏–µ"],
        }

        # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
        self.carts_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "carts")
        if not os.path.exists(self.carts_dir):
            os.makedirs(self.carts_dir)

    def handle(self, message: Message):
        self.send_image(message.chat.id, 1)

    def send_image(self, chat_id: int, image_number: int):
        image_path = os.path.join(self.carts_dir, f"{image_number}.png")
        if not os.path.exists(image_path):
            self.bot.send_message(chat_id, "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ")
            return

        keyboard = InlineKeyboardMarkup()
        buttons = [
            InlineKeyboardButton(
                text=self.button_names[image_number][i],
                callback_data=f"part_{image_number}_{i + 1}"
            ) for i in range(3)
        ]
        for button in buttons:
            keyboard.add(button)


        with open(image_path, "rb") as cart:
            self.bot.send_photo(chat_id, cart, reply_markup=keyboard)


class GameCallbackHandler:
    def __init__(self, bot: TeleBot, game_handler: BotGame):
        self.bot = bot
        self.game_handler = game_handler
        self.selected_parts = defaultdict(lambda: defaultdict(int))

        self.part_texts = {
            1: {
                1: """<b>–í–æ–ø—Ä–æ—Å—ã:</b>
    ‚Ä¢ –ß—Ç–æ —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ –≤—ã –ø—Ä–µ–æ–¥–æ–ª–µ–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥?
    ‚Ä¢ –ö–∞–∫–∏–µ —É—Ä–æ–∫–∏ –≤—ã –∏–∑–≤–ª–µ–∫–ª–∏ –∏–∑ —ç—Ç–æ–≥–æ –æ–ø—ã—Ç–∞?

    <b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ù–∞—Ä–∏—Å—É–π—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –≤—ã –≤–∏–¥–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å –∫ —Ü–µ–ª–∏, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–≥—Ä–∞–¥—ã.""",
                2: """<b>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</b> –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç —É –≤–∞—Å —Å–æ–º–Ω–µ–Ω–∏—è. 
    –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –µ—ë –≤ –≤–∏–¥–µ –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–∞–≥–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ.

    <b>–°–æ–≤–µ—Ç:</b> –ù–∞—á–Ω–∏—Ç–µ —Å –º–∞–ª–æ–≥–æ, –Ω–æ –Ω–∞—á–∏–Ω–∞–π—Ç–µ. –≠—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç –¥–æ—Ä–æ–≥—É –±–æ–ª—å—à–∏–º —É—Å–ø–µ—Ö–∞–º.""",
                3: """<b>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</b> –†–∞–∑–¥–µ–ª–∏—Ç–µ —Å–ª–æ–∂–Ω—É—é –∑–∞–¥–∞—á—É –Ω–∞ —Ç—Ä–∏ –Ω–µ–±–æ–ª—å—à–∏—Ö —à–∞–≥–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∏—Ö –ø–æ—ç—Ç–∞–ø–Ω–æ.

    <b>–°–æ–≤–µ—Ç:</b> –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π—Ç–µ —Å–µ–±—è —Å—Ä–∞–∑—É. –î–µ–ª–∞–π—Ç–µ –º–∞–ª–µ–Ω—å–∫–∏–µ, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω—ã–µ —à–∞–≥–∏."""
            },
            2: {
                1: """<b>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</b> –°–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–∑ 5 —Å–≤–æ–∏—Ö –∫–∞—á–µ—Å—Ç–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –≤–∞–º —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏.

    <b>–°–æ–≤–µ—Ç:</b> –ù–∞–ø–æ–º–∏–Ω–∞–π—Ç–µ —Å–µ–±–µ –æ —Å–≤–æ–∏—Ö —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω–∞—Ö –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç–µ—Å—å —Å –≤—ã–∑–æ–≤–æ–º.""",
                2: """<b>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</b> –ù–∞–ø–∏—à–∏—Ç–µ —Ç—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. 
    –ö–∞–∫–∏–µ —à–∞–≥–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å, —á—Ç–æ–±—ã –∏—Ö —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å?

    <b>–°–æ–≤–µ—Ç:</b> –ò—Å–∫–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–∑–Ω–æ –¥–∞–∂–µ –≤ –ø—Ä–æ—Å—Ç—ã—Ö –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –¥–µ–ª–∞—Ö.""",
                3: """<b>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</b> –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫—É, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å –∏–ª–∏ –¥–∞—Ç—å —Å–æ–≤–µ—Ç. 
    –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤—ã –º–æ–∂–µ—Ç–µ —É–∑–Ω–∞—Ç—å –æ—Ç –Ω–µ–≥–æ?

    <b>–°–æ–≤–µ—Ç:</b> –û–±—â–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã."""
            },
            3: {
                1: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –≤—ã –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —á—É–∂–æ–µ –º–Ω–µ–Ω–∏–µ –æ —Å–µ–±–µ. 
    ‚Ä¢ –ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è —É–≤–µ—Ä–µ–Ω–Ω—ã–º –≤ —Å–µ–±–µ, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è?""",
                2: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –í—Å–ø–æ–º–Ω–∏—Ç–µ, –∫–æ–≥–¥–∞ –≤—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ –ø—Ä–∏–Ω—è—Ç–∏–µ 
    —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–æ–≤ –∏–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π. 
    –ö–∞–∫ —ç—Ç–æ –ø–æ–≤–ª–∏—è–ª–æ –Ω–∞ –≤–∞—à—É —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–≤–æ–∏—Ö —Å–∏–ª–∞—Ö? 
    –ö–∞–∫ –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø—Ä–∏–Ω—è—Ç–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π –≤ –≥—Ä—É–ø–ø–µ?""",
                3: """<b>–í–æ–ø—Ä–æ—Å:</b> –ö—Ç–æ –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è?
    <b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ù–∞–ø–∏—à–∏—Ç–µ –æ —Ç—Ä–µ—Ö –ª—é–¥—è—Ö, —á—å–µ –º–Ω–µ–Ω–∏–µ –¥–ª—è –≤–∞—Å –Ω–∞–∏–±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º–æ. 
    –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤ –∏—Ö —Å–ª–æ–≤–∞—Ö –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è —É–≤–µ—Ä–µ–Ω–Ω–æ?"""
            },
            4: {
                1: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ü–æ–¥—É–º–∞–π—Ç–µ –æ —Å–≤–æ–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –∫–µ–º-—Ç–æ –∏–∑ –≥—Ä—É–ø–ø—ã. 
    –ë—ã–ª–∏ –ª–∏ –≤—ã –¥–æ–≤–æ–ª—å–Ω—ã –æ–±—â–µ–Ω–∏–µ–º? 
    –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –≤ –≤–∞—à–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏, —á—Ç–æ–±—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –±–æ–ª—å—à—É—é —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å?""",
                2: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –û—Ü–µ–Ω–∏—Ç–µ —Å–≤–æ—é ¬´—Å–æ—Ü–∏–∞–ª—å–Ω—É—é –±–∞—Ç–∞—Ä–µ–π–∫—É¬ª –æ—Ç 0 –¥–æ 10.
    –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥—É–º–∞–π—Ç–µ, –∑–∞—Ä—è–∂–∞–µ—Ç –æ–Ω–∞ –≤–∞—Å –∏–ª–∏ —Ä–∞–∑—Ä—è–∂–∞–µ—Ç.
    –ö–∞–∫–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–º–æ–≥–∞—é—Ç –≤–∞–º ¬´–∑–∞—Ä—è–¥–∏—Ç—å—Å—è¬ª?""",
                3: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ù–∞–ø–∏—à–∏—Ç–µ –∞–Ω–æ–Ω–∏–º–Ω–æ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã –∏–ª–∏ –¥–æ–±—Ä—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç—Ä–µ—Ö —á–µ–ª–æ–≤–µ–∫ –∏–∑ –≥—Ä—É–ø–ø—ã. 
    –ü–µ—Ä–µ–¥–∞–π—Ç–µ –∏—Ö, –∏ –æ–±—Å—É–¥–∏—Ç–µ, –∫–∞–∫ —Ç–∞–∫–∏–µ –∂–µ—Å—Ç—ã –≤–ª–∏—è—é—Ç –Ω–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.

    <b>–í–æ–ø—Ä–æ—Å—ã:</b> –ö–æ–≥–¥–∞ –≤—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ —Å–ª—ã—à–∞–ª–∏ –∏—Å–∫—Ä–µ–Ω–Ω—é—é –ø–æ—Ö–≤–∞–ª—É –≤ —Å–≤–æ–π –∞–¥—Ä–µ—Å? 
    –ö–∞–∫ —ç—Ç–æ –Ω–∞ –≤–∞—Å –ø–æ–≤–ª–∏—è–ª–æ?"""
            },
            5: {
                1: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –≤—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ —Å–≤–æ–∏ –ª–∏—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –¥—Ä—É–≥–∏–º–∏ –ª—é–¥—å–º–∏. 
    –ö–∞–∫–∏–µ —Ñ—Ä–∞–∑—ã –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–º–æ–≥–∞—é—Ç –≤–∞–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —ç—Ç–∏ –≥—Ä–∞–Ω–∏—Ü—ã –∏ –∑–∞—â–∏—â–∞—Ç—å—Å—è –æ—Ç –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π?""",
                2: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫ –∏–ª–∏ –¥—Ä—É–≥ –ø—Ä–æ—Å–∏—Ç –≤–∞—Å —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ, 
    —á—Ç–æ –≤–∞–º –Ω–µ—É–¥–æ–±–Ω–æ. –°—ã–≥—Ä–∞–π—Ç–µ –¥–∏–∞–ª–æ–≥, –≥–¥–µ –≤—ã –≤–µ–∂–ª–∏–≤–æ, –Ω–æ —Ç–≤–µ—Ä–¥–æ –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç–µ.

    <b>–í–æ–ø—Ä–æ—Å:</b> –ß—Ç–æ –¥–ª—è –≤–∞—Å —Å–ª–æ–∂–Ω–µ–µ: –≥–æ–≤–æ—Ä–∏—Ç—å ‚Äú–Ω–µ—Ç‚Äù –±–ª–∏–∑–∫–∏–º –ª—é–¥—è–º –∏–ª–∏ –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–∞–º? –ü–æ—á–µ–º—É?""",
                3: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ù–∞–ø–∏—à–∏—Ç–µ —Ç—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –æ—Ç –æ–∫—Ä—É–∂–∞—é—â–∏—Ö. 
    –†–µ—à–∏—Ç–µ, –∫–∞–∫–∏–µ –∏–∑ –Ω–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–∏–º —Ü–µ–Ω–Ω–æ—Å—Ç—è–º, –∞ –∫–∞–∫–∏–µ ‚Äî –Ω–µ—Ç.

    <b>–í–æ–ø—Ä–æ—Å:</b> –ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å —Å–∏—Ç—É–∞—Ü–∏—è–º–∏, –∫–æ–≥–¥–∞ –æ–∂–∏–¥–∞–Ω–∏—è –æ–∫—Ä—É–∂–∞—é—â–∏—Ö –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç 
    —Å –≤–∞—à–∏–º–∏ –∂–µ–ª–∞–Ω–∏—è–º–∏?"""
            },
            6: {
                1: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å, –∫–∞–∫–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–µ–∑–¥–µ –¥–ª—è —É—á—ë–±—ã. 
    –û–±—Å—É–¥–∏—Ç–µ, –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –æ—Å–≤–æ–∏—Ç—å—Å—è –≤ –Ω–æ–≤–æ–º –º–µ—Å—Ç–µ.

    <b>–í–æ–ø—Ä–æ—Å:</b> –ö–∞–∫–∏–µ —à–∞–≥–∏ –ø–æ–º–æ–≥—É—Ç –≤–∞–º –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –∂–∏–∑–Ω–∏ –≤ –Ω–µ–∑–Ω–∞–∫–æ–º–æ–º –≥–æ—Ä–æ–¥–µ?""",
                2: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ü–æ–¥—É–º–∞–π—Ç–µ, —á—Ç–æ —Å–ª–æ–∂–Ω–µ–µ –≤—Å–µ–≥–æ –≤ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏. 
    –ö–∞–∫–∏–µ –ª–∞–π—Ñ—Ö–∞–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç –≤–∞–º –±—ã—Å—Ç—Ä–µ–µ –æ–±—É—Å—Ç—Ä–æ–∏—Ç—å—Å—è –≤ –Ω–æ–≤–æ–º –º–µ—Å—Ç–µ?""",
                3: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–ø–æ—Å–æ–±–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –≤–∞–º —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –Ω–æ—Å—Ç–∞–ª—å–≥–∏–µ–π.

    <b>–í–æ–ø—Ä–æ—Å:</b> –ö–∞–∫–∏–µ –Ω–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å –±—ã—Å—Ç—Ä–µ–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –Ω–æ–≤–æ–º –º–µ—Å—Ç–µ?"""
            },
            7: {
                1: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –í—Å–ø–æ–º–Ω–∏—Ç–µ —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –≤—ã —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å —Å –∫—É–ª—å—Ç—É—Ä–Ω—ã–º–∏ —Ä–∞–∑–ª–∏—á–∏—è–º–∏. 
    –ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å —Å —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π?

    <b>–í–æ–ø—Ä–æ—Å:</b> –ö–∞–∫ –º–æ–∂–Ω–æ –Ω–∞–ª–∞–¥–∏—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è–º–∏ –¥—Ä—É–≥–∏—Ö –∫—É–ª—å—Ç—É—Ä?""",
                2: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤ –≤ –Ω–æ–≤–æ–π —Å—Ä–µ–¥–µ. 
    –ö–∞–∫–∏–µ —Ç–µ–º—ã –ª—É—á—à–µ –Ω–µ –ø–æ–¥–Ω–∏–º–∞—Ç—å –≤ –Ω–∞—á–∞–ª–µ –æ–±—â–µ–Ω–∏—è?

    <b>–í–æ–ø—Ä–æ—Å:</b> –ö–∞–∫ –ª–µ–≥–∫–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤–ª–∏—Ç—å—Å—è –≤ –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é?""",
                3: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–º–æ–≥–∞—é—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–≤—è–∑—å —Å–æ —Å–≤–æ–∏–º–∏ —Ç—Ä–∞–¥–∏—Ü–∏—è–º–∏
    –∏ —Ä–æ–¥–Ω—ã–º —è–∑—ã–∫–æ–º –≤ –Ω–æ–≤–æ–π —Å—Ä–µ–¥–µ.

    <b>–í–æ–ø—Ä–æ—Å:</b> –ö–∞–∫ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –Ω–æ–≤—É—é –∫—É–ª—å—Ç—É—Ä—É, –Ω–µ —Ç–µ—Ä—è—è —Å–≤—è–∑–∏ —Å —Ä–æ–¥–Ω–æ–π?"""
            },
            8: {
                1: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –±–æ—Ä—å–±—ã —Å —Ç—Ä–µ–≤–æ–≥–æ–π –ø–µ—Ä–µ–¥ —ç–∫–∑–∞–º–µ–Ω–∞–º–∏. 
    –ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ?""",
                2: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –í—Å–ø–æ–º–Ω–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –≤—ã –Ω–µ –ø–æ–Ω–∏–º–∞–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è. –ö–∞–∫ –≤—ã –Ω–∞—à–ª–∏ –≤—ã—Ö–æ–¥?

    <b>–í–æ–ø—Ä–æ—Å:</b> –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –∫–∞–∂–µ—Ç—Å—è –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–º –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–º?""",
                3: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –û–±—Å—É–¥–∏—Ç–µ, –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

    <b>–í–æ–ø—Ä–æ—Å:</b> –ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–µ—Ä–µ–≥—Ä—É–∑–∫–æ–π?"""
            },
            9: {
                1: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –í—Å–ø–æ–º–Ω–∏—Ç–µ –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ –≤—ã —Ç–µ—Ä—è–ª–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é. –ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–ª–∏—Å—å —Å —ç—Ç–∏–º?

    <b>–í–æ–ø—Ä–æ—Å:</b> –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –ø—Ä–æ–ø–∞–ª–æ –∂–µ–ª–∞–Ω–∏–µ —É—á–∏—Ç—å—Å—è?""",
                2: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏. –ö–∞–∫–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç –≤–∞–º –≤—Å—ë —É—Å–ø–µ–≤–∞—Ç—å?

    <b>–í–æ–ø—Ä–æ—Å:</b> –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ–±—è?""",
                3: """<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –í—Å–ø–æ–º–Ω–∏—Ç–µ —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ –≤–∞–º –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º —Å–≤–æ—é —Ç–æ—á–∫—É –∑—Ä–µ–Ω–∏—è. 
    –ö–∞–∫ –≤—ã —Å —ç—Ç–∏–º —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å?

    <b>–í–æ–ø—Ä–æ—Å:</b> –ö–∞–∫ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏?"""
            }
        }

    def handle(self, call: CallbackQuery):
        data = call.data.split("_")
        action = data[0]
        chat_id = call.message.chat.id

        if action == "part":
            image_number = int(data[1])
            part_number = int(data[2])

            if self.selected_parts[chat_id][image_number] != 0:
                self.bot.answer_callback_query(call.id, "–í—ã —É–∂–µ –≤—ã–±—Ä–∞–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É!")
                return

            self.selected_parts[chat_id][image_number] = part_number
            self.bot.send_message(
                chat_id,
                self.part_texts.get(image_number, {}).get(part_number, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."),
                parse_mode='HTML'
            )
            self.send_next_button(chat_id, image_number)

        elif action == "next":
            image_number = int(data[1])

            if image_number < 9:
                self.game_handler.send_image(chat_id, image_number + 1)
            else:
                self.bot.send_message(chat_id, "üéâ –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∏–≥—Ä—É! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å' –∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –µ—é.")
                self.selected_parts[chat_id].clear()

        self.bot.answer_callback_query(call.id)

    def send_next_button(self, chat_id: int, image_number: int):
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("–î–∞–ª—å—à–µ ‚Üí", callback_data=f"next_{image_number}"))
        self.bot.send_message(chat_id, "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É!", reply_markup=keyboard)


class FeedbackBot:
    def __init__(self, token: str):
        self.bot = TeleBot(token)
        self.game_handler = BotGame(self.bot)
        self.handlers = {
            "start": StartHandler(self.bot),
            "feedback": FeedbackHandler(self.bot),
            "help": HelpHandler(self.bot),
            "resources": ResourcesHandler(self.bot),
            "feedback_callback": FeedbackCallbackHandler(self.bot),
            "game": self.game_handler,
            "game_callback": GameCallbackHandler(self.bot, self.game_handler),
        }
        self.register_handlers()

    def register_handlers(self):
        self.bot.message_handler(commands=['start'])(lambda msg: self.handlers["start"].handle(msg))

        self.bot.message_handler(func=lambda m: m.text == "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å")(
            lambda msg: self.handlers["feedback"].handle(msg))
        self.bot.message_handler(func=lambda m: m.text == "–ü–æ–º–æ—â—å")(
            lambda msg: self.handlers["help"].handle(msg))
        self.bot.message_handler(func=lambda m: m.text == "–¶–∏—Ñ—Ä–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã")(
            lambda msg: self.handlers["resources"].handle(msg))
        self.bot.message_handler(func=lambda m: m.text == "–ò–≥—Ä–∞")(
            lambda msg: self.handlers["game"].handle(msg))

        self.bot.callback_query_handler(func=lambda c: c.data in ("liked", "add", "cancel_feedback", "feedback_end"))(
            lambda call: self.handlers["feedback_callback"].handle(call))

        self.bot.callback_query_handler(func=lambda c: c.data.startswith(("part", "next")))(
            lambda call: self.handlers["game_callback"].handle(call))

        self.bot.message_handler(func=lambda m: self.handlers["feedback_callback"].states.get(m.chat.id, {}).get(
            "state") == "waiting_feedback")(
            self.handle_feedback_text)

    def handle_feedback_text(self, message: Message):
        state = self.handlers["feedback_callback"].states.get(message.chat.id)
        if not state:
            return

        feedback_type = state["type"]
        self.save_feedback(message, feedback_type)
        del self.handlers["feedback_callback"].states[message.chat.id]

        markup = InlineKeyboardMarkup(row_width=2)
        markup.add(
            InlineKeyboardButton("–ß—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å", callback_data="liked"),
            InlineKeyboardButton("–ß—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å", callback_data="add"),
            InlineKeyboardButton("–ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data="feedback_end")
        )
        self.bot.send_message(
            message.chat.id,
            "‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å! –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –µ—â—ë?",
            reply_markup=markup
        )

    @staticmethod
    def save_feedback(message: Message, category: str):
        with db.create_session() as session:
            try:
                student = session.get(Students, message.from_user.id)
                if not student:
                    student = Students(
                        id=message.from_user.id,
                        name=message.from_user.full_name
                    )
                    session.add(student)

                feedback = Feedback(
                    message=message.text,
                    category=category
                )
                session.add(feedback)
                session.commit()
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
                session.rollback()

    @staticmethod
    def markup_main() -> ReplyKeyboardMarkup:
        markup = ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        markup.add(
            "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å",
            "–ò–≥—Ä–∞",
            "–¶–∏—Ñ—Ä–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã",
            "–ü–æ–º–æ—â—å"
        )
        return markup

    def run(self):
        print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
        self.bot.infinity_polling()


if __name__ == "__main__":
    bot = FeedbackBot(TOKEN)
    bot.run()